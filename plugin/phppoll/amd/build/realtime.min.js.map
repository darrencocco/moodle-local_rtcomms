{"version":3,"file":"realtime.min.js","sources":["../src/realtime.js"],"sourcesContent":["/**\n * Real time events\n *\n * @module     realtimeplugin_phppoll/realtime\n * @copyright  2024 Darren Cocco\n */\ndefine(['tool_realtime/api'], function(api) {\n    const phpPollPrototype = {\n\n        pollType: {\n            short: 1,\n            long: 2,\n        },\n\n\n        ajaxOnReadyStateChange(self) {\n            return function() {\n                if (this.readyState === XMLHttpRequest.DONE) {\n                    if (this.status === 200) {\n                        try {\n                            let json = JSON.parse(this.responseText);\n                            // Process results - trigger all necessary Javascript/jQuery events.\n                            // FIXME: not handling Moodle errors correctly\n                            let events = json.events;\n                            for (let i in events) {\n                                api.publish(events[i]);\n                                // Remember the last id.\n                                self.params.lastIdSeen = Number(events[i].id);\n                            }\n                            this.errorCounter = 0;\n                        } catch {\n                            this.errorCounter++;\n                        }\n                    } else {\n                        this.errorCounter++;\n                    }\n                    self.resetTimeout();\n                    self.queueNextPoll();\n                }\n            };\n        },\n\n        poll() {\n            if (this.channels < 1) {\n                return;\n            }\n\n            if (this.errorCounter > this.params.maxFailures) {\n                // Notify subscribers that something has gone wrong.\n                api.connectionFailure();\n            }\n\n            let url = this.pollURL + '?userid=' + encodeURIComponent(this.params.userid) + '&token=' +\n            encodeURIComponent(this.params.token) +\n                (this.params.lastIdSeen === -1 ?\n                '&since=' + encodeURIComponent(this.params.earliestMessageCreationTime) :\n                '&lastidseen=' + encodeURIComponent(this.params.lastIdSeen));\n\n            this.ajax.open('GET', url, true);\n            this.ajax.send();\n        },\n\n        queueNextPoll() {\n            if (!this.timeout) {\n                this.timeout = setTimeout(this.poll.bind(this),\n                    Math.max(2 ** this.errorCounter * 1000, this.params.maxDelay));\n            }\n        },\n\n        resetTimeout() {\n            this.timeout = null;\n        },\n        init(userId, token, pollURLParam, maxDelay, maxFailures, earliestMessageCreationTime, pollType) {\n            if (this.params && this.params.userid) {\n                // Log console dev error.\n            } else {\n                this.params = {\n                    userid: userId,\n                    token: token,\n                    maxDelay: maxDelay,\n                    maxFailures: maxFailures,\n                    earliestMessageCreationTime: earliestMessageCreationTime,\n                    lastIdSeen: -1,\n                    pollType: pollType === 'short' ? pollType.short : pollType.long,\n                };\n            }\n            this.pollURL = pollURLParam;\n            this.ajax.onreadystatechange = this.ajaxOnReadyStateChange(this);\n            api.setImplementation(pub);\n        },\n        subscribe() {\n            this.channels++;\n            this.queueNextPoll();\n        }\n    };\n\n    /**\n     * Handles interacting with PHP Poll DB plugin.\n     * @constructor\n     */\n    function PhpPoll() {\n        this.params = null;\n        this.channels = 0;\n        this.pollURL = null;\n        this.ajax =  new XMLHttpRequest();\n        this.json = null;\n        this.timeout = null;\n        this.errorCounter = 0;\n    }\n    Object.assign(PhpPoll.prototype, phpPollPrototype);\n    let instance = new PhpPoll();\n    let pub = {\n        init: (userId, token, pollURLParam, maxDelay, maxFailures, earliestMessageCreationTime, pollType) => {\n            instance.init(userId, token, pollURLParam, maxDelay, maxFailures, earliestMessageCreationTime, pollType);\n        },\n        subscribe: () => {\n            instance.subscribe();\n        },\n    };\n    return pub;\n});"],"names":["define","api","phpPollPrototype","pollType","short","long","ajaxOnReadyStateChange","self","this","readyState","XMLHttpRequest","DONE","status","events","JSON","parse","responseText","i","publish","params","lastIdSeen","Number","id","errorCounter","resetTimeout","queueNextPoll","poll","channels","maxFailures","connectionFailure","url","pollURL","encodeURIComponent","userid","token","earliestMessageCreationTime","ajax","open","send","timeout","setTimeout","bind","Math","max","maxDelay","init","userId","pollURLParam","onreadystatechange","setImplementation","pub","subscribe","PhpPoll","json","Object","assign","prototype","instance"],"mappings":"AAMAA,yCAAO,CAAC,sBAAsB,SAASC,WAC7BC,iBAAmB,CAErBC,SAAU,CACNC,MAAO,EACPC,KAAM,GAIVC,uBAAuBC,MACZ,cACCC,KAAKC,aAAeC,eAAeC,KAAM,IACrB,MAAhBH,KAAKI,eAKGC,OAHOC,KAAKC,MAAMP,KAAKQ,cAGTH,WACb,IAAII,KAAKJ,OACVZ,IAAIiB,QAAQL,OAAOI,IAEnBV,KAAKY,OAAOC,WAAaC,OAAOR,OAAOI,GAAGK,SAEzCC,aAAe,EACtB,WACOA,yBAGJA,eAEThB,KAAKiB,eACLjB,KAAKkB,kBAKjBC,UACQlB,KAAKmB,SAAW,SAIhBnB,KAAKe,aAAef,KAAKW,OAAOS,aAEhC3B,IAAI4B,wBAGJC,IAAMtB,KAAKuB,QAAU,WAAaC,mBAAmBxB,KAAKW,OAAOc,QAAU,UAC/ED,mBAAmBxB,KAAKW,OAAOe,SACE,IAA5B1B,KAAKW,OAAOC,WACb,UAAYY,mBAAmBxB,KAAKW,OAAOgB,6BAC3C,eAAiBH,mBAAmBxB,KAAKW,OAAOC,kBAE/CgB,KAAKC,KAAK,MAAOP,KAAK,QACtBM,KAAKE,QAGdb,gBACSjB,KAAK+B,eACDA,QAAUC,WAAWhC,KAAKkB,KAAKe,KAAKjC,MACrCkC,KAAKC,IAAI,GAAKnC,KAAKe,aAAe,IAAMf,KAAKW,OAAOyB,aAIhEpB,oBACSe,QAAU,MAEnBM,KAAKC,OAAQZ,MAAOa,aAAcH,SAAUhB,YAAaO,4BAA6BhC,UAC9EK,KAAKW,QAAUX,KAAKW,OAAOc,cAGtBd,OAAS,CACVc,OAAQa,OACRZ,MAAOA,MACPU,SAAUA,SACVhB,YAAaA,YACbO,4BAA6BA,4BAC7Bf,YAAa,EACbjB,SAAuB,UAAbA,SAAuBA,SAASC,MAAQD,SAASE,YAG9D0B,QAAUgB,kBACVX,KAAKY,mBAAqBxC,KAAKF,uBAAuBE,MAC3DP,IAAIgD,kBAAkBC,MAE1BC,iBACSxB,gBACAF,2BAQJ2B,eACAjC,OAAS,UACTQ,SAAW,OACXI,QAAU,UACVK,KAAQ,IAAI1B,oBACZ2C,KAAO,UACPd,QAAU,UACVhB,aAAe,EAExB+B,OAAOC,OAAOH,QAAQI,UAAWtD,sBAC7BuD,SAAW,IAAIL,QACfF,IAAM,CACNL,KAAM,CAACC,OAAQZ,MAAOa,aAAcH,SAAUhB,YAAaO,4BAA6BhC,YACpFsD,SAASZ,KAAKC,OAAQZ,MAAOa,aAAcH,SAAUhB,YAAaO,4BAA6BhC,WAEnGgD,UAAW,KACPM,SAASN,qBAGVD"}